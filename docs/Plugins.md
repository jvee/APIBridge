# Плагины

## Архитектура плагина
Плагин должен быть изолирован от внешнего мира, т.к. предполагается, что он может входить в бандл и не должен пересекаться с кишками библиотеки. Изоляцию можно проводить на этапе сборки бандла.

##### plugin.js
```javascript
// хэндлеры лучше содержать в отдельных модулях, для удобства тестирования
var stageHandler = require('stage-handler');
var ruleHandler = require('rule-handler');

var plugin = {
  name: 'Plugin'
  stages: {
    stageName: stageHandler
  }
  extendRules: {
    ruleName: ruleHandler,
  },
  source: ruleHandler
}

module.exports = plugin;
```

### Объект-описание плагина
* ``name`` - строка с имененм плагина, используется для однозначной идентификации
* ``stages`` - перечисление стадий в виде ``stageName: stageHandler``, на которых используются хэндлеры плагина.
* ``extendRules``  - перечисление extend-правил в виде ``ruleName: ruleHandler``, на которых используются хэндлеры плагина
* ``source`` - может содержать что угода, для тестирования **DEPRECATED**

### Подключение в бандле

```javascript
var rapier = require('rapier');
// обязательно делать require в отдельную переменную для сборки
var rapierPlugin = require('rapier-plugin');

rapier.registerPlugin(rapierPlugin);

module.exports = rapier;
```

### Подключение в API
```javascript
var rapier = require('rapier');
var rapierPlugin = require('rapier-plugin');
var SomeApiDeclarartion = require('some-api-declaration');

var SomeApi = rapier(SomeApiDeclarartion)

// Плагин будет подключен только к нужному аpi
// и не будет зарегестрирован во всей библиотеке
SomeApi.__setPlugin(rapierPlugin);

module.exports = SomeApi;
```

### Загрузка отдельно от библиотеки
Плагин должен быть обернут как UMD-модуль (в случае использования на клиенте) или как CJS-модуль, и должен возвращать свой объект-описание. Затем вручную плагин регистрируеися в библиотеке или подключается к API. В случае клиентского использования сохраняется в глобальную область видимости.
**_Возможно подключение в определенный неймспейс_?**

### Сборка
Изначально плагин пишется как CJS-модуль (даже в случае браузера).
При сборке плагина в бандл он изолируется в анонимную функцию, которая возвращает объект описания плагина.
Важно помнить, что ``pluginName`` будет браться из имени файла, для которого происходит сборка.
```javascript
var pluginName = (function () {
  var plugin = {/*...*/}
  // "module.exports = " => "return"
  return plugin
})();
```
В случае сборки плагина как самостоятельной сущности происходит простое оборачивание в UMD-обертку

### Контекст выполннения хэндлеров плагина
* Extend-правила всегда выполняются в контексте ``null``
* В хэндлеры стадий передается ``apiModel`` **ЗАЧЕМ?**, но это значение можно изменить, передав в ``options`` инициализации нужное значение ``_ctx``

### Опции
В данный момент нет возможности передавать опции плагина. Они могут понадобиться, но пока нет острой необходимости в их существовании. Идеи настроек плагина:
* Приоритет для хэндлеров на различных стадиях
* Признак ``default``, при котором плагин будет устанавливаться для всех последующих сборок API

### Автоматическиая инициализация плагина
От автоматической инициализации пришлось отказаться для того, что лучше иметь строгий контроль над подключаемыми плагинами, а также эта вещь несколько увеличивает размер плагина, которой хочется избежать. Так же это добавляет некоторую путаницу в сборке. Возможно что-то подобное появится в будущем, но пока это не приоритетная задача.

## Roadmap
* Реализация модуля ``PluginManager.js`` для работы с плагинами
  * ``new PluginManager(executor)``
  * ``PluginManager.add``
  * ``PluginManager.remove``
  * ``PlguinManager.resetExecutor``
  * ``PluginManager.buildStageArray``
* Вынести префикс в настройки
* Реализация метода ``rapier.registerPlugin``
* Реализация метода ``api.__setPlugin``
* Сборка
* Оторвать поддержку ``_ctx`` в хэндлерах
* Boilerplate шаблон для плагина (структура, сборка, тесты)


## Возможные улучшения системы плагинов
* Переинициализация (для изменения настроек, например приоритет)
* Возможность игнорировать плагины при сборке API
* ``rapier.resetPlugin(plugin)`` - удаление или сброс к исходным
* Опции инициализации плагинов
* Изменить префикс в имени стадии плагsина (``_`` => ``plugin-``)
* Автоматическая инициализация плагина
